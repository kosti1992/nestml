/* BeginDocumentation
   Name: amat2_psc_exp - Non-resetting leaky integrate-and-fire neuron model
                         with exponential PSCs and adaptive threshold.

   Description:
   amat2_psc_exp is an implementation of a leaky integrate-and-fire model
   with exponential shaped postsynaptic currents (PSCs). Thus, postsynaptic
   currents have an infinitely short rise time.

   The threshold is lifted when the neuron is fired and then decreases in a
   fixed time scale toward a fixed level [3].

   The threshold crossing is followed by a total refractory period
   during which the neuron is not allowed to fire, even if the membrane
   potential exceeds the threshold. The membrane potential is NOT reset,
   but continuously integrated.

   The linear subthresold dynamics is integrated by the Exact
   Integration scheme [1]. The neuron dynamics is solved on the time
   grid given by the computation step size. Incoming as well as emitted
   spikes are forced to that grid.

   An additional state variable and the corresponding differential
   equation represents a piecewise constant external current.

   The general framework for the consistent formulation of systems with
   neuron like dynamics interacting by point events is described in
   [1]. A flow chart can be found in [2].

   Remarks:
       - The default parameter values for this model are different from the
         corresponding parameter values for mat2_psc_exp.
       - If identical parameters are used, and beta==0, then this model shall
         behave exactly as mat2_psc_exp.
       - The time constants in the model must fullfill the following conditions:
         - tau_m != {tau_syn_ex, tau_syn_in}
         - tau_v != {tau_syn_ex, tau_syn_in}
         - tau_m != tau_v
         This is required to avoid singularities in the numerics. This is a
         problem of implementation only, not a principal problem of the model.
       - Expect unstable numerics if time constants that are required to be
         different are very close.

   Parameters:
   The following parameters can be set in the status dictionary:

   C_m          double - Capacity of the membrane in pF
   E_L          double - Resting potential in mV
   tau_m        double - Membrane time constant in ms
   tau_syn_ex   double - Time constant of postsynaptic excitatory currents in ms
   tau_syn_in   double - Time constant of postsynaptic inhibitory currents in ms
   t_ref        double - Duration of absolute refractory period (no spiking) in
                         ms
   V_m          double - Membrane potential in mV
   I_e          double - Constant input current in pA
   t_spike      double - Point in time of last spike in ms
   tau_1        double - Short time constant of adaptive threshold in ms
                         [3, eqs 2-3]
   tau_2        double - Long time constant of adaptive threshold in ms
                         [3, eqs 2-3]
   alpha_1      double - Amplitude of short time threshold adaption in mV
                         [3, eqs 2-3]
   alpha_2      double - Amplitude of long time threshold adaption in mV
                         [3, eqs 2-3]
   tau_v        double - Time constant of kernel for voltage-dependent threshold
                         component in ms [3, eqs 16-17]
   beta         double - Scaling coefficient for voltage-dependent threshold
                         component in 1/ms [3, eqs 16-17]
   omega        double - Resting spike threshold in mV (absolute value, not
                         relative to E_L as in [3])

   The following state variables can be read out with the multimeter device:

   V_m          Non-resetting membrane potential
   V_th         Two-timescale adaptive threshold

   Remarks:
   tau_m != tau_syn_{ex,in} is required by the current implementation to avoid a
   degenerate case of the ODE describing the model [1]. For very similar values,
   numerics will be unstable.

   References:
   [1] Rotter S & Diesmann M (1999) Exact simulation of
       time-invariant linear systems with applications to neuronal
       modeling. Biologial Cybernetics 81:381-402.
   [2] Diesmann M, Gewaltig M-O, Rotter S, & Aertsen A (2001) State
       space analysis of synchronous spiking in cortical neural
       networks. Neurocomputing 38-40:565-571.
   [3] Kobayashi R, Tsubo Y and Shinomoto S (2009) Made-to-order
       spiking neuron model equipped with a multi-timescale adaptive
       threshold. Front. Comput. Neurosci. 3:9. doi:10.3389/neuro.10.009.2009
   [4] Yamauchi S, Kim H and Shinomoto S (2011) Elemental spiking neuron model
               for reproducing diverse firing patterns and predicting precise
               firing times. Front. Comput. Neurosci. 5:42.
               doi: 10.3389/fncom.2011.00042

   Sends: SpikeEvent

   Receives: SpikeEvent, CurrentEvent, DataLoggingRequest

   FirstVersion: April 2013
   Author: Thomas Heiberg & Hans E. Plesser (modified mat2_psc_exp model of
   Thomas Pfeil)
*/
neuron amat2_psc_exp_nestml:

  state:
    V_1 mV
    function V_th mV = E_L + omega + V_th_alpha_1 + V_th_alpha_2 + V_th_v
    V_th_alpha_1 mV
    V_th_alpha_2 mV
    V_th_dv mV
    V_th_v mV
    function V_m mV = V_1 + E_L # Membrane potential.
  end

  equations:
    shape I_shape_in = exp(-1/tau_syn_in*t)
    shape I_shape_ex = exp(-1/tau_syn_ex*t)

    shape G_alpha1 = delta(t, tau1)
    shape G_alpha2 = delta(t, tau2)

    V_th_alpha_1' = -V_th_alpha_1/tau_1 + alpha_1*I_sum(G_alpha1, in_spikes)
    V_th_alpha_2' = -V_th_alpha_2/tau_2 + alpha_2*I_sum(G_alpha2, ex_spikes)

    V_1' = -1/tau_m * V_1 + 1/C_m * (I_sum(I_shape_in, in_spikes) + I_sum(I_shape_ex, ex_spikes) + I_e + currents)
  end

  parameter:
    tau_m        ms =     10ms  # Membrane time constant in ms
    C_m          pF =   200pF  # Capacity of the membrane in pF
    t_ref        ms =     2ms  # Duration of absolute refractory period (no spiking) in ms
    E_L          mV = -70.0mV  # Resting potential in mV
    I_e          pA =     0pA  # Constant input current in pA
    tau_syn_ex   ms =     1ms  # Time constant of postsynaptic excitatory currents in ms
    tau_syn_in   ms =     3ms  # Time constant of postsynaptic inhibitory currents in ms
    tau_1        ms =    10ms  # Short time constant of adaptive threshold in ms
    tau_2        ms =   200ms  # Long time constant of adaptive threshold in ms
    alpha_1      mV =  10.0mV  # Amplitude of short time threshold adaption in mV [3]
    alpha_2      mV =   0.0mV  # Amplitude of long time threshold adaption in mV [3]
    tau_v        ms =   5ms  # Long time constant of adaptive threshold in ms
    omega        mV =   19.0mV # Resting spike threshold in mV (absolute value, not relative to E_L) here it should be
  end

  internal:
    r integer
    h_new ms = resolution()
    P11th real = exp( -h_new / tau_1 )
    P22th real = exp( -h_new / tau_2 )
    RefractoryCounts integer = steps(t_ref)
  end

  input:
    ex_spikes   <- excitatory spike
    in_spikes   <- inhibitory spike
    currents    <- current
  end

  output: spike

  update:
    integrate(V_1)
    #integrate(V_th_alpha_1)
    #integrate(V_th_alpha_2)

    V_th_alpha_1 *= P11th
    V_th_alpha_2 *= P22th

    if r == 0: # not refractory
      if V_1 >= omega + V_th_alpha_1 + V_th_alpha_2 + V_th: # threshold crossing
          r = RefractoryCounts

          # procedure for adaptive potential
          V_th_alpha_1 += alpha_1 # short time
          V_th_alpha_2 += alpha_2 # long time

          emit_spike()
      end
    else:
        r = r - 1
    end

  end

end
